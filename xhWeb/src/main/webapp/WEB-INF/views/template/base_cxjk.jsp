<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://www.rapid-framework.org.cn/rapid" prefix="rapid" %>
<%@taglib prefix="shiro" uri="http://shiro.apache.org/tags" %>
<c:set var="ctx" value="${pageContext.request.contextPath}" />
<c:set var="rs" value="${ctx}/resources"/>
<!DOCTYPE html>
<html lang="en" class="no-js">
<!-- BEGIN HEAD -->
<head>
<meta charset="utf-8"/>
<title>宁波市公共信用信息工作平台</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="" name="description"/>
<meta content="" name="author"/>
<!-- BEGIN GLOBAL MANDATORY STYLES -->
<link href="${rs}/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/uniform/css/uniform.default.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css"/>
<!-- END GLOBAL MANDATORY STYLES -->
<!-- BEGIN PAGE LEVEL PLUGIN STYLES -->
<link href="${rs}/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/jqvmap/jqvmap/jqvmap.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/plugins/morris/morris.css" rel="stylesheet" type="text/css">
<!-- END PAGE LEVEL PLUGIN STYLES -->
<!-- BEGIN PAGE STYLES -->
<link href="${rs}/admin/pages/css/tasks.css" rel="stylesheet" type="text/css"/>
<!-- END PAGE STYLES -->
<!-- BEGIN THEME STYLES -->
<!-- DOC: To use 'rounded corners' style just load 'components-rounded.css' stylesheet instead of 'components.css' in the below style tag -->
<link href="${rs}/global/css/components-rounded.css" id="style_components" rel="stylesheet" type="text/css"/>
<link href="${rs}/global/css/plugins.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/admin/layout4/css/layout.css" rel="stylesheet" type="text/css"/>
<link href="${rs}/admin/layout4/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color"/>
<link href="${rs}/admin/layout4/css/custom.css" rel="stylesheet" type="text/css"/>

<!--[if IE 8]>
<link href="${rs}/admin/layout4/css/ie8.css" rel="stylesheet" type="text/css"/>
<![endif]-->

<!--bootstrap modal-->
<link href="${rs}/js/plugins/bootstrap-dialog/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
<link href="${rs}/global/plugins/jquery-file-upload/css/jquery.fileupload-ui.css" rel="stylesheet" type="text/css" />
<link href="${rs}/global/plugins/jquery-file-upload/css/jquery.fileupload.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="${rs}/css/zTree/zTreeStyle/zTreeStyle.css" type="text/css">

 <LINK href="${rs}/js/style.css" rel="stylesheet" type="text/css">
<!--bootstrap modal-->
<rapid:block name="css"></rapid:block>	
<!-- END THEME STYLES -->
<link rel="shortcut icon" href="favicon.ico"/>
</head>
<!-- END HEAD -->
<style>
	.page-header.navbar{ background-color:#005c94;}
	.page-header.navbar .search-form{ background:none;}
	.page-header.navbar .top-menu .navbar-nav > li.dropdown.open .dropdown-toggle {
  background-color: #f1f1f1;
}

</style>

<OBJECT id=InfoSecNetSign1 
codebase=NetSign20.cab#version=2.0.59.9
data=DATA:application/x-oleobject;BASE64,xDi5YpBBN0+M8KkrCpHMdwADAACgRwAA/wIAAA== 
classid=clsid:B3B938C4-4190-4F37-8CF0-A92B0A91CC77 
VIEWASTEXT width="0" height="0"></OBJECT> 


<body class="page-header-fixed page-sidebar-closed-hide-logo page-sidebar-closed-hide-logo">

<!-- BEGIN HEADER -->

<div class="">
	<!-- BEGIN HEADER INNER -->
	<div class="page-header-inner">
		<!-- BEGIN LOGO -->
		
				<div class="page-logo">
					
<div id="bgDiv" class = "bgDiv"   style="display:none;position:absolute;top:0;background:#777;filter:progid:DXImageTransform.Microsoft.Alpha(style=3,opacity=25,finishOpacity=75);opacity:0.7;left:0;">
</div>
 <div  id="calogin" class="calogin portlet box grey-cascade" style="display:none;" >
	 <div class = "portlet-title" style="background-color:#428bca;">
	 	<div class="caption2"  >请选择您要用的证书
	 	</div>
	 </div>
	 <div   id="cacert" class = "portlet-body" style ="min-height:150px;_height:150px; "  >
	 </div>
  </div>
  
  
 
 <div  id="calogin2" class="calogin2 portlet box grey-cascade" style="display:none;" >
	 <div class = "portlet-title" style="background-color:#428bca;">
	 	<div class="caption2"> 提示
	 	</div>
	 </div>
	 <div   id="cacert2" class = "portlet-body" style ="min-height:150px;_height:150px;  "  >
		 <div style=" text-align:left;font-size:16px;padding:15px;text-indent:2em;">请插入新版数字证书，并根据<a href="/nbggxy/head" target="_blank">数字证书安装流程</a>,下载并更新<a href="/nbggxy/file/download">数字证书客户端和驱动程序</a>。如有问题，可与信用中心联系，联系电话87360806。
</div>
		 <br>
		 <div><input type = "button" value = "确定" onclick = "ex()" style="margin-bottom: 15px;" class="btn btn-primary"></input></div>
 
	 </div>
	  
  </div>
				</div>
		<!-- END LOGO -->
		<!-- BEGIN RESPONSIVE MENU TOGGLER -->
		<a href="javascript:;" class="menu-toggler responsive-toggler hide" data-toggle="collapse" data-target=".navbar-collapse">
		</a>
		<!-- END RESPONSIVE MENU TOGGLER -->
		<!-- BEGIN PAGE ACTIONS -->
		<!-- DOC: Remove "hide" class to enable the page header actions -->
		
		<!-- END PAGE ACTIONS -->
		
		
		<!-- BEGIN PAGE TOP -->
		<div class="page-top">
			<!-- BEGIN HEADER SEARCH BOX -->
			<!-- DOC: Apply "search-form-expanded" right after the "search-form" class to have half expanded search box -->
			
			<!-- END HEADER SEARCH BOX -->
			<!-- BEGIN TOP NAVIGATION MENU -->
			<!-- END TOP NAVIGATION MENU -->
		</div>
		<!-- END PAGE TOP -->
	</div>
	<!-- END HEADER INNER -->
</div>
<!-- END HEADER -->


<div class="clearfix">
</div>

<!-- BEGIN CONTAINER -->
<div class="page-container">
	<!-- BEGIN SIDEBAR -->
	<div class="page-sidebar-wrapper">
		<!-- DOC: Set data-auto-scroll="false" to disable the sidebar from auto scrolling/focusing -->
		<!-- DOC: Change data-auto-speed="200" to adjust the sub menu slide up/down speed -->
	</div>
	<!-- END SIDEBAR -->
	<!-- BEGIN CONTENT -->
	
	<div class="">
		<div class=""> 
			<rapid:block name="content"> </rapid:block>	
		</div>	
	</div>
	<!-- END CONTENT -->
</div>
<!-- END CONTAINER -->


<!-- <div class="page-footer" style="text-align:center; background:#f2f2f2;height:120px;margin-top:-25px;" >  -->
<!-- 	<div style="padding:2px; margin-top:30px;">	2015 &copy; 宁波市公共信用信息平台  </div> -->
<!-- 	<div>技术支持：中国软件与技术服务股份有限公司 宁波分公司</div> -->
<!--     <div><span>技术支持联系电话：0574-83873513</span>&nbsp;&nbsp;<span>0574-87360806</span></div> -->
<!--     <div   style="background:#f2f2f2;" ></div> -->
<!-- </div> -->

 

<!-- <div    > -->

<div style="display:none;"  >

 <H2 align="center">ZJCA KeyManager JavaScript DEMO</H2>
    <FORM name="form1" action="">
    <FIELDSET>
        <LEGEND>密码设备：</LEGEND>    
        <TABLE>
            <COLGROUP>
            <COL class="col1">
            <COL class="col2">
            <COL class="col3">
            <TBODY>
            <TR>
                <TD></TD>
                <TD></TD>
                <TD></TD>
            </TR>  
            <TR>          
                <TD>请选择设备类型: </TD>          
                <TD>
                    <input type="radio" name="chkBtnKeyType" onclick="FindDeviceList(2)"/>RSA设备
                    <input type="radio" name="chkBtnKeyType" onclick="FindDeviceList(3)"/>SM2设备
                </TD> 
            </TR>   
            <TR>
                <TD>请选择Key：             </TD>
                <TD colspan="2"><SELECT name="selKeys" onchange="OnSelKeyChanged()"></SELECT></TD>
            </TR>
            </TBODY>
        </TABLE>
    </FIELDSET>
    <BR>
    <FIELDSET>
        <LEGEND>Key Info：</LEGEND>         
        <TABLE>
        <COLGROUP>
            <COL class="col1">
            <COL class="col2">
            <COL class="col3">
            <TBODY>
            <TR>
                <TD></TD>
                <TD></TD>
                <TD></TD>
            </TR>
            <TR>
                <TD>SN:                 </TD>
                <TD><INPUT name="txtSN" type="text" readonly="readonly"></TD>
                <TD><INPUT name="btnChangePin" class="keyBtn" onclick="OnChangePin()" type="button" value="ChangePin"></TD>
            </TR>
            <TR>
                <TD>                    Label:                 </TD>
                <TD><INPUT name="txtLabel" type="text" readonly="readonly"></TD>
                <TD><INPUT name="btnSignCert" class="keyBtn" onclick="OnSelectCert(true)" type="button" value="获取签名证书"></TD>
            </TR>
            <TR>
                <TD colspan="2"></TD>
                <TD><INPUT name="btnSignCert" class="keyBtn" onclick="OnSelectCert(false)" type="button" value="获取加密证书"></TD>
            </TR>
           
            </TBODY>
        </TABLE>
    </FIELDSET>
    <BR>
    <FIELDSET>
        <LEGEND>证书：</LEGEND>
        <TEXTAREA name="txtCert" id ="txtCert" rows="5" cols="70"></TEXTAREA>
        <INPUT name="IDCardNo" id="IDCardNo"  type="text"  >
        <INPUT name="loginuser" id="loginuser"  type="text" >
        <INPUT name="result" id="result"  type="text" value="">
    </FIELDSET>
    <BR>
    <FIELDSET>
        <LEGEND>签名/加解密</LEGEND>
        原文：         
        <TABLE>
            <TBODY>
            <TR>
                <TD>
                    <INPUT name="MsgSource" id="rdMessage" type="radio" value="1" checked="1"><LABEL for="rdMessage">消息</LABEL>
                </TD>
                <TD>
                    <TEXTAREA name="txtPlainText" rows="5" cols="60">123456</TEXTAREA>
                </TD>
            </TR>
            <TR>
                <TD>
                    <INPUT name="MsgSource" id="rdFile" type="radio" value="2"><LABEL for="rdFile">File</LABEL> 
                </TD>
				<TD>
					<INPUT name="txtFileName" type="text" readonly="readonly">
					<INPUT name="btnOpenSrcFile" onclick="on_OpenSrcFile();" type="button" value="打开文件">
				</TD>
            </TR>
            </TBODY>
        </TABLE>
        <HR>
        <TABLE>
            <COLGROUP>
            <COL class="col1">
            <COL class="col2">
            <COL class="col3">
            <TBODY>
            <TR>
                <TD>
                </TD>
                <TD>
                </TD>
                <TD>
                </TD>
            </TR>
            <TR>
				<TD style="vertical-align:top;">
					签名格式: 
				</TD>
				<TD style="vertical-align:top;">
					<SELECT name="selSignatureFormat" onchange="OnSelSignatureFormatChanged()" readonly="true" style="width:200px;margin-left:-80px;">
						<option value = 1>PKCS#1</Option>
						<option value = 2>PKCS#7</Option>
					</SELECT>
				</TD>
                <TD>
                    <INPUT name="btnSign" class="keyBtn" onclick="t();" type="button" value="Sign"><BR>
					<INPUT name="btnShowSigCert" class="certBtn" onclick="on_btnShowSigInfo();" type="button" value="显示签名证书信息"><BR>
					<INPUT name="btnVerify" class="certBtn" onclick="on_btnVerify();" type="button" value="Verify"> 
                </TD>
            </TR>
            </TBODY>
        </TABLE>
        签名结果:         
        <TEXTAREA name="txtSignedData" id ="txtSignedData" rows="5" cols="70"></TEXTAREA>
        <HR>
    </FIELDSET>
    <BR>
<!--     <div id="s" class="sss" hidden ></div> -->
    </FORM>
</div>

<!-- ca证书 -->
<script type="text/javascript"src="${rs}/js/ca_script.js"></script> 
<script src="${rs}/global/plugins/jquery.cookie.js" type="text/javascript"></script>
<SCRIPT type="text/javascript" src="${rs}/js/zjcacom.js"></SCRIPT>
<script type="text/javascript" src="${rs}/js/ADDCXJK.js"></script>
    
    <!--[if lte IE 6]>
    <link href="css/style_ie6.css" rel="stylesheet" type="text/css" /> 
    <script src="css/IE8.js" type="text/javascript"></script>
    <![endif]--> 
    
    
<SCRIPT type="text/javascript">
		/* 当前ZJCA客户端的版本 */
		var g_ZJCAClientVer = "1.0.0.0";
		
		/* 当前显示的证书对象 */
		var g_SelCertObj = null;
		
		/* 当前选择的签名结果格式(默认P1) */
		var g_SignatureFormat = 1;	
		
		/* 当前选择的密文结果格式(默认P1) */
		var g_CipherFormat = 1;
		
		/*
		 *	页面初始化
		 */
		window.onload = function() {
			//初始化COM组件
			zjca_Init();			
			
			//获取组件版本
			var versionObj = new ActiveXObject("ZJCAKeyManager.ZJCAVersion.1");
			g_ZJCAClientVer = versionObj.GetVersion();
			
			//默认使用RSA设备
			document.form1.chkBtnKeyType[0].checked = true;
			FindDeviceList(3);
		}
		
		/*
		 *	页面关闭
		 */
		window.onunload = function () {
			zjca_Final();
		}
        /*
         *  枚举设备
         *  参数deviceType为：1-CSP设备(不建议使用，将来会删除)；2-PKCS11设备；3-国密设备
         */
		function FindDeviceList(deviceType) {
			var item;
			var signFormatSelectCtrl = document.form1.selSignatureFormat;
			
			signFormatSelectCtrl.options.length = 0;
		
			
			// 更新UI
		    if (2 == deviceType) {
                document.form1.btnShowSigCert.disabled = false;
				
				//刷新“签名格式”选项
				signFormatSelectCtrl.options.add(new Option("PKCS#1", 1));
				signFormatSelectCtrl.options.add(new Option("PKCS#7", 2));
				
						
            }
            else {
                document.form1.btnShowSigCert.disabled = true;				
				
				
					//刷新“签名格式”选项
					//signFormatSelectCtrl.options.add(new Option("RAW", 3));
					signFormatSelectCtrl.options.add(new Option("ASN.1", 4));
	
            }		
			OnSelSignatureFormatChanged();
			//OnSelCipherFormatChanged();

			//更新设备列表
			zjca_FillKeyList(document.form1.selKeys, deviceType);			
		}

        /*
         *  选择设备，列出选中设备的基本信息
         */
		function OnSelKeyChanged() {
		    var devSelectCtrl = document.form1.selKeys;
		    var selectIndex = devSelectCtrl.options.selectedIndex;
		    var deviceIndex = devSelectCtrl.options.value;

			

			deviceSel = deviceArray[deviceIndex];

		    deviceEnum.get_Item(deviceIndex, deviceSel);


		    if (deviceSel != null) {
		        try {
		            document.form1.txtSN.value = deviceSel.SN;
		            document.form1.txtLabel.value = deviceSel.Label;
		        }
		        catch (e) {
		            alert(e.message);
		        }
		    }
		    else {
		        document.form1.txtSN.value = "";
		        document.form1.txtLabel.value = "";
		    }
		}

        /*
         *  修改用户PIN码
         */
		function OnChangePin() {
			
		}
		
		/*
		 *	选择证书
		 */
		 function OnSelectCert(isSignCert) {		 
		    if (deviceSel == null) {
				alert("请选择设备！");
				return;
			}
			
			g_SelCertObj = zjca_GetCert(deviceCurType, deviceSel, isSignCert);
			ShowCertInfo(g_SelCertObj);			
		 }
		 
		 /*
		  *	解析证书(将证书内容以Base64格式输入) 
		  */
        function on_parseCert(pCertString) {
			try {
				g_SelCertObj = zjca_ParseCertificate(pCertString);
				ShowCertInfo(g_SelCertObj);
			}
			catch(e) {
				if (e.message != "") {
					alert(e.message);
				}
				else {
					alert("操作失d败!");
				}
			}
        }
                



		
		/*
		 *	显示证书内容和信息
		 */
        function ShowCertInfo(pCertificate) {
			//document.form1.selCertExtend.options[0].selected = true;    
			//OnSelCertExtendChanged();
			
            if (pCertificate == null) {
                document.form1.txtCert.value = "no cert!";
               
            } else {
				var certType = pCertificate.CertType;
				document.form1.txtCert.value = pCertificate.ToString();
				
				document.form1.loginuser.value = pCertificate.SN;
				document.form1.IDCardNo.value =pCertificate.IDCardNo;
            }
        }
		/*
		 *	打开原文文件
		 */
		 function on_OpenSrcFile() {
			var streamfactory = new ActiveXObject("ZJCAKeyManager.ZJCAStreamFactory.1");
			var file = streamfactory.OpenFileDialog("打开文件", "");
			document.form1.txtFileName.value = file;
		 }
		 
		/*
		 *	打开密文文件
		 */
		 function on_OpenDesFile() {
			var streamfactory = new ActiveXObject("ZJCAKeyManager.ZJCAStreamFactory.1");
			var file = streamfactory.OpenFileDialog("保存文件", "");
			document.form1.txtDesFileName.value = file;
		 }
		
		/*
		 *	选择签名格式
		 */
		function OnSelSignatureFormatChanged() {
		    var formatSelectCtrl = document.form1.selSignatureFormat;
		    g_SignatureFormat = formatSelectCtrl.options.value;
		}
		
		/*
		 *	签名数据
		 */
		 function t(obj1,obj2){
			
				var deviceIndex;
				var btnSign = document.getElementsByTagName("input").btnSign;
				btnSign.setAttribute("disabled","true") ; 
	 			// console.log(btnSign.disabled);
	 		try{
				for (var i = 0; i < deviceArray.length; i++) {
					if(deviceArray[i] == deviceSel){
						deviceIndex = i;
					}
				}
	 			
			}catch(e){ 
// 				 alert("请插入新版数字证书，并更新数字证书客户端和驱动程序。如有问题，可联系87360806信用中心杨磊。"); 
				 document.getElementById("bgDiv").style.display = "block";
				 document.getElementById("calogin2").style.display = "block"; 
				 return;
				}
			adds(deviceCurType,obj1,obj2);

		 }
		 function ex(){
			 document.getElementById("bgDiv").style.display = "none";
			 document.getElementById("calogin2").style.display = "none"; 
		 }
        function on_btnSign(dev) {
            var signature;
           
            if (document.form1.rdMessage.checked) {
                var data = document.form1.txtPlainText.value;
                signature = zjca_SignMsg(dev, data, g_SignatureFormat);
            } else if (document.form1.rdFile.checked) {
                var file = document.form1.txtFileName.value;
				if (file == "") {
					alert("请选择要签名的文件！");
					return;
				}
                signature = zjca_SignFile(dev, file, g_SignatureFormat);
            } else if (document.form1.rdUrl.checked) {
            	var url = document.form1.signurl.value;
            	signature = zjca_SignUrl(dev, url, g_SignatureFormat);
            }
            
            if (signature) {
                document.form1.txtSignedData.value = signature;
            } else {
                document.form1.txtSignedData.value = "";
            }

        }

		/*
		 *	显示签名数据的签名证书信息
		 */
        function on_btnShowSigInfo() {
            var signedData = document.form1.txtSignedData.value;
            var signature = zjca_ParseSignature(signedData);
            if(signature) {
				var signCert = new ActiveXObject("ZJCAKeyManager.ZJCACertificate.1");
				var content = signature.get_Content(3);
	        	if(content) alert( "原文：\r\n" + content);
				else alert("该签名中无原文信息!");
				signature.get_Certificate(signCert);
				g_SelCertObj = signCert;
	            ShowCertInfo(signCert);
	        }
        }
		
		/*
		 *	验证签名
		 */
        function on_btnVerify() {		
			var bPassed = false;
			var certificate = document.form1.txtCert.value;
			var signature = document.form1.txtSignedData.value;
			var signObj = zjca_ParseSignature(signature);
			var signAlg = signObj.AlgId;
			
			try {
				var org;
				var encode = 0;
				var streamfactory = null;
				
				// 创建证书对象
				var certObj = new ActiveXObject("ZJCAKeyManager.ZJCACertificate.1");
				if (certificate != null && certificate != "") {
					certObj.FromString(certificate);
				}
				else {
					certObj = null;
				}				
				
				// 验签消息
				if (document.form1.rdMessage.checked) {
					org = document.form1.txtPlainText.value;
					encode = 0x03;
				}
				// 验签文件
				else if (document.form1.rdFile.checked) {
					var filename = document.form1.txtFileName.value;
					if (filename == "") {
						alert("请选择要验签的原始文件！");
						return;
					}
					streamfactory = new ActiveXObject("ZJCAKeyManager.ZJCAStreamFactory.1");
					var fileStream = streamfactory.GetFileStream(filename, 1);
					if (fileStream == null) {
						alert("打开文件失败！");
						return;
					}	
					org = fileStream;
					encode = 0x00;
				}
				else {
					alert("操作不支持!");
					return;
				}
								
				// RSA签名,可以直接验签
				if (1 == signAlg) {
					bPassed = signObj.Verify(org, encode, certObj, "");
				}
				// SM2签名,需要借助Key验签
				else {
					if (deviceSel == null) {
						alert("请选择设备！");
						return;
					}
					if (document.form1.rdMessage.checked) {
						bPassed = zjca_VerifyMsg(deviceSel, certObj, signature, org);
					}
					else {
						bPassed = zjca_VerifyFile(deviceSel, certObj, signature, org);
					}				
				}
				// 释放文件
				if (document.form1.rdFile.checked) {
					streamfactory.CloseStream(org);
				}
				// 显示结果
				if (bPassed){
					alert("验证通过。");
				} else {
					alert("Verify failed.");
				}
			} catch (e) {
				alert("!!!"+typeof (e) + " error" + e.number + ": " + e.description);
			}
        }

	
		

		

</SCRIPT>












<!-- <div class="page-footer" style="text-align:center;">  -->
<!-- 		技术支持：中国软件与技术服务股份有限公司 宁波分公司 -->
<!-- </div> -->
<!-- END FOOTER -->
<!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->
<!-- BEGIN CORE PLUGINS -->

<script src="${rs}/global/plugins/jquery.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jquery-migrate.min.js" type="text/javascript"></script>
<!-- IMPORTANT! Load jquery-ui.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip -->
<script src="${rs}/global/plugins/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/uniform/jquery.uniform.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
<!-- END CORE PLUGINS -->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script src="${rs}/global/plugins/jqvmap/jqvmap/jquery.vmap.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.russia.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.world.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.europe.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.germany.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.usa.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/jqvmap/jqvmap/data/jquery.vmap.sampledata.js" type="text/javascript"></script>
<!-- IMPORTANT! fullcalendar depends on jquery-ui.min.js for drag & drop support -->

<script src="${rs}/global/plugins/morris/raphael-min.js" type="text/javascript"></script>
<%-- <script src="${rs}/global/plugins/jquery.sparkline.min.js" type="text/javascript"></script> --%>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL SCRIPTS -->
<script src="${rs}/global/scripts/metronic.js" type="text/javascript"></script>
<script src="${rs}/admin/layout4/scripts/layout.js" type="text/javascript"></script>
<script src="${rs}/admin/layout2/scripts/quick-sidebar.js" type="text/javascript"></script>
<script src="${rs}/admin/layout4/scripts/demo.js" type="text/javascript"></script>

<script src="${rs}/js/plugins/bootstrap-dialog/js/bootstrap-dialog.min.js"></script>
<script src="${rs}/scripts/My97DatePicker/WdatePicker.js" type="text/javascript" ></script>
<script src="${rs}/admin/pages/scripts/tasks.js" type="text/javascript"></script>

<script src="${rs}/global/plugins/multiselect/jquery.form.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/multiselect/multiselect.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/multiselect/jquery.easyui.min.js" type="text/javascript"></script>
<script src="${rs}/global/plugins/multiselect/easyui.css" type="text/javascript"></script>
<script type="text/javascript"src="${rs}/js/zTree/jquery.ztree.core-3.5.min.js"></script>


<!-- END PAGE LEVEL SCRIPTS -->

<script>
//modify by jiangln at 20160824 增加CA验证
//判断是否需要ca
function CA(){  
 
	var result =  $("#result").val(); 
	alert("result"+result);
	return result;
}

//end modify 
jQuery(document).ready(function() {
	
	
   Metronic.init(); // init metronic core componets
   Layout.init(); // init layout
   Demo.init(); // init demo features
   QuickSidebar.init(); // init quick sidebar
    //Index.init(); // init index page
 Tasks.initDashboardWidget(); // init tash dashboard widget  
//  alert(1);
 //常用功能默认打开
 
 //modify by wangmin at 20160627 for关闭搜索框
 $(".tools").append('<button id="searchtwo" class="btn btn-sm blue filter-submit margin-bottom "><i class="fa fa-search"></i> <span id="searchc">显示查询条件</span></button><a id="searchone" class="collapse"  style="display:none;"></a>');

	  $("#searchone").trigger("click");
	  $("#searchtwo").toggle(
			  function () {
				  $("#searchone").trigger("click");
			    $("#searchc").html("隐藏查询条件");
			  },
			  function () {
				  $("#searchone").trigger("click");
				  $("#searchc").html("显示查询条件");
			  }
			);
	  
	 
 

 //END 关闭搜索框
 
 
 var strCookie=document.cookie;
	var zclm = "";

	var arrCookie=strCookie.split("; "); 
	//遍历cookie数组，处理每个cookie对
	for(var i=0;i<arrCookie.length;i++){
	             var arr=arrCookie[i].split("=");
	             //找到名称为lm的cookie，并返回它的值
	             if("lm"==arr[0]){
	            	 zclm=arr[1];
	  				 break;
	             }
	} 
	
//	alert(zclm);
	var zccd = zclm.split("-");  //左侧菜单数组
	
//  alert(zccd);
	if(zccd=="" || zccd=="n,n,n,n"){
		 $("#常用功能").trigger("click");
	}

//  alert(2)
// alert( $("#常用功能").html());
});



// function logout(){
	
// 	window.location.href = "${ctx}/logout";
// }
function modifyUserData(){
//   	var xlh = "";
<%-- 	if('<%=request.getSession().getAttribute("ISCA")%>'=="N"){ --%>
<%-- 		xlh ='<%=request.getSession().getAttribute("S_CABZF")%>'; --%>
// 	}else{
<%-- 	  xlh =cazs_select('<%=request.getSession().getAttribute("S_CABZF")%>');  --%>
// 	} 
// 	 if(xlh!="error"){
// 	 $.ajax({
// 			url : '${ctx}/testca',
// 			type : "POST",
// 			data : {
// 				"passport" : xlh 
// 			},
// 			dataType : "json"
// 		}).done(function(resultData, ss) {
// 			if(resultData.SFYX=='Y'){ 
	window.location.href = "${ctx }/users/toModifyUserData";
	

// }else{
// 	layer.msg('无此CA用户。');
// }
// }).fail(function(jqXHR, textStatus, errirThrown) {
// layer.msg('数据加载失败,请稍后重试');
// });

// }else{
// layer.msg("请确认安装数字证书客户端。");
// }
	
	 
}

     

			
function delCookie(name)
{
var exp = new Date();
exp.setTime(exp.getTime() - 1);
var cval=getCookie(name);
if(cval!=null)
document.cookie= name + "="+cval+";expires="+exp.toGMTString();
}


function ajax3(){  
		var txtCert =  $("#txtCert").val();//证书 
		var txtSignedData =  $("#txtSignedData").val();//签名结果
		var IDCardNo =  $("#IDCardNo").val();//身份证号 
		$.ajax({				 
				url : '${ctx}/netsignForCxjk',
				type : "POST",
				async:false,//同步加载
				data : {
					passport : txtCert , 
					txtSignedData:txtSignedData,
					IDCardNo:IDCardNo
				},
				dataType : "json"
			}).done(function(resultData, ss) {
				//alert('resultData.SFYX='+resultData.SFYX)
				if(resultData.SFYX=='Y'){ 
				      //操作
						result='Y';
						$("#result").val(result);
						 $("#cabzf").val(resultData.CABZF); 
					}else if(resultData.SFYX=='W'){
						result='CA证书与用户不匹配。';
						$("#result").val(result);
					}else if(resultData.SFYX=='N'){
						result='CA验证失败。';
						$("#result").val(result);
					}else{
						result='cancel';
						$("#result").val(result);
					}
			}).fail(function(jqXHR, textStatus, errirThrown) {
				layer.msg('数据加载失败,请稍后重试');
			}); 
}

function casubmit(url,i,j,k,b,SFCAYZ){
	
	var lm = i+"-"+j+"-"+k+"-"+b; 
	document.cookie="lm="+lm+";path=/";  
	if(SFCAYZ=="1"&&'<%=request.getSession().getAttribute("S_Y")%>'!=1){
		 
	t("casubmit0",url);
		
}else{
	window.location.href = "${ctx}"+url;
}
} 
function casubmit0(url){  
	 var result= CA(); 
	     if(result=='Y'){
	    	//操作 
			  window.location.href = "${ctx}"+url;
 	     }else if(result=='cancel'){
	        //取消
	     }else{
	    	layer.msg(result);
	     }
//   $("#cabzf").val(resultData.CABZF); 
//		window.location.href = "${ctx}"+url;
}
function setCookie(c_name,value,expiredays){    
	var exdate=new Date()    
	exdate.setDate(exdate.getDate()+expiredays)    
	document.cookie=c_name+ "=" +escape(value)+   
	((expiredays==null) ? "" : ";expires="+exdate.toGMTString())
	}//读取cookie
function getCookie(c_name){    
		if (document.cookie.length>0)      
		{     
			c_start=document.cookie.indexOf(c_name + "=")      
			if (c_start!=-1)       
			{        
				c_start=c_start + c_name.length+1        
				c_end=document.cookie.indexOf(";",c_start)        
				if (c_end==-1) c_end=document.cookie.length        
				return unescape(document.cookie.substring(c_start,c_end))  
				}       
			}    
		return ""
	}
// function casubmit2(){  
// 	var cabzf = $("#cabzf").val(); 
// 	 if(cabzf=="0"){ 
<%-- 	 var xlh =cazs_select('<%=request.getSession().getAttribute("S_CABZF")%>');   --%>
	 
	//	 if(xlh!="error"){
// 		 $.ajax({
// 				url : '${ctx}/testca',
// 				type : "POST",
// 				data : {
// 					"passport" : xlh 
// 				},
// 				dataType : "json"
// 			}).done(function(resultData, ss) {
// 				if(resultData.SFYX=='Y'){
// 					//window.location.href = "${ctx}"+url;
// 				 $("#cabzf").val(resultData.CABZF);
// 				}else{
// 					layer.msg('无此CA用户。');
// 				}
// 			}).fail(function(jqXHR, textStatus, errirThrown) {
// 				layer.msg('数据加载失败,请稍后重试');
// 			});
	 
// 		 }else{
// 			 layer.msg("请确认安装数字证书客户端。");
// 		 }
	 
		 
// 	 }
// }
</script>



<SCRIPT ID=clientEventHandlersJS LANGUAGE=javascript>
 
//******** Making Attached sign on Client
function buttonAttachedSign_onclick() {
	 
	InfoSecNetSign1.NSSetPlainText("ca测试"); 
	if(InfoSecNetSign1.errorNum!=0)
		{ 
			alert("返回值〔"+InfoSecNetSign1.errorNum+"〕\n"+InfoSecNetSign1.errMsg);
			return ;
		}
	else	
	{	 
 
// 		document.getElementById("sig_client").value =InfoSecNetSign1.NSAttachedSign(""); 
		document.getElementById("sig_client").value =InfoSecNetSign1.NSUseSpecAdvanceAttachedSign("");
 
//    		alert(  "1"+   InfoSecNetSign1.NSGetSignerCertInfo(1)  ) 
//    		alert(  "2"+   InfoSecNetSign1.NSGetSignerCertInfo(2)  ) 
//    		alert(  "3"+   InfoSecNetSign1.NSGetSignerCertInfo(3)  ) 
//    		alert(  "4"+   InfoSecNetSign1.NSGetSignerCertInfo(4)  ) 
//    		alert(  "5"+   InfoSecNetSign1.NSGetSignerCertInfo(5)  ) 
		
// 		  alert(InfoSecNetSign1.NSGetSignerCertInfo(1).substring(InfoSecNetSign1.NSGetSignerCertInfo(1).indexOf("CN=")+3))
		  document.getElementById("loginuser").value =InfoSecNetSign1.NSGetSignerCertInfo(5);
		
		if(InfoSecNetSign1.errorNum!=0)
		{
			alert("返回值〔"+InfoSecNetSign1.errorNum+"〕\n"+InfoSecNetSign1.errMsg);
			return ;
		}
	}   
}
</script>
<!-- END JAVASCRIPTS -->
<input type="text" id = "cabzf" value = "0" style="display:none;"></input>
</body>
<!-- END BODY -->


<rapid:block name="script"></rapid:block>

</body>
</html>